/*
 **************************************************************************************************
 *                        桂林聚联科技有限公司
 *
 *  文件描述： 记录OTDR的各个表格数据
 *
 *
 *  文件名  ： OtdrTable.c
 *  创建者  ： 彭怀敏
 *  创建日期： 2011-12-30  15:57:00
 *  当前版本： v1.0
 * 
 ***** 修改记录 *****
 *  修改者  ： 
 *  修改日期： 
 *  备    注： 
 **************************************************************************************************
*/
#include <stdio.h>
#include <math.h>

#include "Otdr.h"
#include "protocol.h"
#include "DspFpgaReg.h"

#define CLK_16  1

/*************************************************************************************************/
/*********************************** 为OTDR各个参数建立表格 **************************************/
/*************************************************************************************************/

/*********************** 量程，单位m，1公里量程合并在5公里量程里 *********************************/
const Uint32 OtdrMeasureLength[MEASURE_LENGTH_NUM] = 
//    1km   5km   10km   30km   60km   100km   180km
    { 1000, 5000, 10000, 30000, 60000, 100000, 180000};

/******************************* 量程对应的采样率，单位MHz ***************************************/
#define DATA_POINT_32K 0
#if DATA_POINT_32K
/****************************** 量程对应的脉冲周期，单位us ***************************************/
const float OtdrPulsePeriod[MEASURE_LENGTH_NUM] = 
//    1km     5km   10km  30km   60km   100km  180km
//    { 200 , 200 , 400 , 606 ,  1000 , 1333 ,  2666};      // 旧 2013-7-10 11:05:44
#if CLK_16
{ 100 ,  312.5, 500 , 1000 , 1000 , 2666 , 2666};
#else
{ 312.5, 312.5, 500 , 1000 , 1000 , 2666 , 2666};
#endif

//////////////////////////////////////////////////////////////////////////
/******************************* 量程对应的采样率，单位MHz ***************************************/
const Uint32 OtdrSampleRate[MEASURE_LENGTH_NUM] = 
//      1km          5km         10km        30km       60km       100km     180km
//    {CLK_400MHz, CLK_400MHz, CLK_200MHz, CLK_100MHz, CLK_50MHz, CLK_25MHz, CLK_12MHz};     // 旧 2013-7-10 11:05:44
#if CLK_16
{CLK_800MHz, CLK_400MHz, CLK_200MHz, CLK_100MHz, CLK_50MHz,  CLK_25MHz,  CLK_12MHz};
#else
{CLK_400MHz, CLK_400MHz, CLK_200MHz, CLK_100MHz, CLK_50MHz,  CLK_25MHz,  CLK_12MHz};
#endif

/******************************* 量程对应的采样率，单位 Hz ***************************************/
const Uint32 OtdrSampleRateHz[MEASURE_LENGTH_NUM] = 
//    1km     5km     10km    30km   60km   100km  180km
//    {400e6 , 400e6 , 200e6 , 100e6 , 50e6 , 25e6 , 125e5};     // 旧 2013-7-10 11:05:44
#if CLK_16
{800e6 ,  400e6 ,  200e6 ,   100e6 ,    50e6 ,     25e6 ,    125e5};
#else
{400e6 ,  400e6 ,  200e6 ,   100e6 ,    50e6 ,     25e6 ,    125e5};
#endif
//////////////////////////////////////////////////////////////////////////
#else //不采用32K采样点
//////////////////////////////////////////////////////////////////////////
const float OtdrPulsePeriod[MEASURE_LENGTH_NUM] = 
//    1km     5km   10km  30km   60km   100km  180km
//    { 200 , 200 , 400 , 606 ,  1000 , 1333 ,  2666};      // 旧 2013-7-10 11:05:44
#if CLK_16
/*{	 312.5, 500 , 1000 , 1000 , 2666 , 2666, 2666};*/		//kj目前用的就fpga板子，因此需使用修改一下
   { 312.5, 500 , 1000 , 1000 , 1000 , 2666, 2666};
#else
{	312.5, 312.5, 500 , 1000 , 1000 , 2666 , 2666};
#endif
/******************************* 量程对应的采样率，单位MHz ***************************************/
const Uint32 OtdrSampleRate[MEASURE_LENGTH_NUM] = 
//      1km          5km         10km        30km       60km       100km     180km
//    {CLK_400MHz, CLK_400MHz, CLK_200MHz, CLK_100MHz, CLK_50MHz, CLK_25MHz, CLK_12MHz};     // 旧 2013-7-10 11:05:44
#if CLK_16
{CLK_400MHz, CLK_200MHz, CLK_100MHz, CLK_50MHz, CLK_25MHz,  CLK_12MHz,  CLK_12MHz};
#else
{CLK_400MHz, CLK_400MHz, CLK_200MHz, CLK_100MHz, CLK_50MHz,  CLK_25MHz,  CLK_12MHz};
#endif

/******************************* 量程对应的采样率，单位 Hz ***************************************/
const Uint32 OtdrSampleRateHz[MEASURE_LENGTH_NUM] = 
//    1km     5km     10km    30km   60km   100km  180km
//    {400e6 , 400e6 , 200e6 , 100e6 , 50e6 , 25e6 , 125e5};     // 旧 2013-7-10 11:05:44
#if CLK_16
{400e6 ,  200e6 ,  100e6 ,   50e6 ,    25e6 ,  125e5 ,   125e5};
#else
{400e6 ,  400e6 ,  200e6 ,   100e6 ,    50e6 ,     25e6 ,    125e5};
#endif
//////////////////////////////////////////////////////////////////////////
#endif 
//////////////////////////////////////////////////////////////////////////



/******************************* 量程允许最小脉宽，单位ns ****************************************/
const Uint16 OtdrMinAllowPulseWidth[MEASURE_LENGTH_NUM] = 
//    1km   5km   10km  30km  60km  100km  180km
    { 5  ,  5  ,  5  ,  10 ,  20 ,  40 ,   80};

/******************************* 量程允许最大脉宽，单位ns ****************************************/
const Uint16 OtdrMaxAllowPulseWidth[MEASURE_LENGTH_NUM] = 
//    1km   5km   10km   30km   60km   100km   180km
    { 80 ,  160 , 320 ,  1280 , 2560,  10240,  20480};

/******************************* 量程对应最小脉宽，单位ns ****************************************/
const Uint16 OtdrMinPulseWidth[MEASURE_LENGTH_NUM] = 
//    1km   5km   10km  30km  60km  100km  180km
    { 5  ,  5  ,  20 ,  40 ,  80 ,  640 ,  1280};

/******************************* 量程对应最大脉宽，单位ns ****************************************/
const Uint16 OtdrMaxPulseWidth[MEASURE_LENGTH_NUM] = 
//    1km   5km   10km  30km   60km   100km   180km
    { 160 , 320 , 640 , 1280 , 2560 , 10240 , 20480};

/***************************** 量程对应自动默认脉宽，单位ns **************************************/
const Uint16 OtdrDefaultPulseWidth[MEASURE_LENGTH_NUM] = 
//    1km   5km   10km  30km   60km   100km   180km
    { 80 ,  160,  320 , 640 ,  1280,  2560 ,  5120};

/************************** (多模)量程对应自动默认脉宽，单位ns ***********************************/
const Uint16 OtdrDefaultPulseWidth_NMF[MEASURE_LENGTH_NUM] = 
//    1km   5km   10km  30km   60km   100km   180km
    { 40 ,  80 ,  160 , 320 ,  640 ,  1280 ,  2560};

/*********************** 自动测试时，根据结束处的曲线高度来自动匹配脉宽 **************************/
const Uint16 OtdrDefaultPulseWidth_AUTO[MEASURE_LENGTH_NUM][6] =
{
// (dB)      < 5     5 ~ 9    9 ~ 13   13 ~ 17  17 ~ 21    > 21
/*   1km */ { 80   ,   40   ,   20  ,    10  ,    10  ,     10 },
/*   5km */ { 160  ,   80   ,   40  ,    20  ,    10  ,     10 },
/*  10km */ { 320  ,   160  ,   80  ,    40  ,    20  ,     20 },
/*  30km */ { 640  ,   320  ,   160 ,    80  ,    40  ,     20 },
/*  60km */ { 1280 ,   640  ,   320 ,    160 ,    80  ,     40 },
/* 100km */ { 10240,   5120 ,   2560,    1280,    640 ,     320},
/* 180km */ { 20480,   10240,   5120,    2560,    1280,     640},
};

/********************************** 各个波长在OTDR内的下标索引 ***********************************/
const Uint16 OtdrLambdaIndex[LAMBDA_NUM] = 
{
    1310, 1550, 1625, 850, 1300, 1490, 1610, 1590
};

/********************************** 默认映射到1550激光器的波长 ***********************************/
const Uint16 OtdrDefaultLaserMap1550[6] = 
{
    850, 1550, 1590, 1610, 1625, 1650
};

/******************************* 大脉宽对应的盲区，单位米 ****************************************/
const Uint32 OtdrBlindZone[2][6] = 
{
// 高16位是该脉宽下低功率测试时间，单位是秒，低16位是盲区长度，单位是米
//                     640ns          1280ns          2560ns            5120ns           10240ns         20480ns
#if TR600_A_CLASS
/* 1310nm */    {(5<<16) | 1000,  (4<<16) | 1000,  (3<<16) | 1000,  (2<<16) | 1000,  (2<<16) | 1200,  (2<<16) | 2000}, 
/* 1550nm */    {(5<<16) | 1000,  (4<<16) | 1000,  (3<<16) | 1000,  (2<<16) | 1000,  (2<<16) | 1200,  (2<<16) | 1800}, 
#else   // TR600_C_CLASS
/* 1310nm */    {(5<<16) | 200,  (4<<16) | 400,  (3<<16) | 800,  (2<<16) | 1600,  (2<<16) | 2600,  (2<<16) | 4000}, 
/* 1550nm */    {(5<<16) | 150,  (4<<16) | 300,  (3<<16) | 600,  (2<<16) | 1200,  (2<<16) | 1800,  (2<<16) | 2600}, 
#endif
};

/*************************** 各个量程不同脉宽对应的曲线起始点 ************************************/
const Uint16 OtdrStartPoint[MEASURE_LENGTH_NUM] = 
//  1km   5km   10km   30km   60km   100km   180km
{
// #if CLK_16
    // 142,  73 ,  48 ,   35 ,   28 ,   23 ,    21
// #else
    // 73 ,  73 ,  48 ,   35 ,   28 ,   23 ,    21
// #endif
#if CLK_16	// 2015-12-14 10:28 重新确定后的新起点
    166,  83 ,  51 ,   36 ,   29 ,   24 ,    22
#else
    83,  83 ,  51 ,   36 ,   29 ,   24 ,    22
#endif
};

/****************************** 各个量程不同脉宽对应的事件盲区 ***********************************/
const float OtdrEventBlindZone[PULSE_WIDTH_NUM] = 
{
//  10ns  10ns  20ns  40ns  80ns  160ns  320ns  640ns  1us  2us  5us  10us  20us
    2  ,  3.5,  4.5,   6 ,   12 ,  25 ,   55 ,  100,   190, 350, 600, 1500, 2500
};

/********************************** 启动事件算法的时间刻度 ***************************************/
const Uint32 OtdrEventAlgoTimeTick[9][MAX_GROUP_NUM-1] = 
{
//            1      2      3      4
/*   5s */  {2000 , 4000 , 0    , 0     },  
/*  10s */  {2000 , 4000 , 6000 , 8000  },  
/*  15s */  {3000 , 6000 , 9000 , 12000 },  
/*  30s */  {5000 , 8000 , 15000, 24000 },  
/*  60s */  {7000 , 15000, 30000, 45000 },  
/*  90s */  {9000 , 20000, 50000, 70000 },  
/* 120s */  {12000, 30000, 50000, 90000 },  
/* 150s */  {15000, 40000, 80000, 120000},  
/* 180s */  {18000, 50000, 90000, 140000},  
};

/*********************** 拼接时，不同量程脉宽波长使用的功率控制控制门数 **************************/
const Uint16 OtdrPowerLevel1310[MEASURE_LENGTH_NUM][PULSE_WIDTH_NUM] = 
{
//            5ns  10ns  20ns  40ns  80ns   160ns  320ns   640ns     1280ns     2560ns     5120ns    10240ns    20480ns
#if TR600_A_CLASS
/*   1km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 ,     2 ,        2 ,        2 ,        1 ,        1,         1 },
/*   5km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 ,     2 ,        2 ,        2 ,        1 ,        1,         1 },
/*  10km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 ,     2 ,        2 ,        2 ,        1 ,        1,         1 },
/*  30km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 ,     2 ,        2 ,        2 ,        1 ,        1,         1 },
/*  60km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 ,     2 ,        2 ,        2 ,        1 ,        1,         1 },
/* 100km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 , (2 <<8)|2, (2 <<8)|2, (2 <<8)|2, (2 <<8)|1, (2 <<8)|1, (2 <<8)|1},
/* 180km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 , (2 <<8)|2, (2 <<8)|2, (2 <<8)|2, (2 <<8)|1, (2 <<8)|1, (2 <<8)|1},
#else   // TR600_C_CLASS
/*   1km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 ,     4 ,        4 ,        4 ,        4 ,        4,         4 },
/*   5km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 ,     4 ,        4 ,        4 ,        4 ,        4,         4 },
/*  10km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 ,     4 ,        4 ,        4 ,        4 ,        4 ,        4 },
/*  30km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 ,     4 ,        4 ,        4 ,        4 ,        4 ,        4 },
/*  60km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 ,     4 ,        4 ,        4 ,        4 ,        4 ,        4 },
/* 100km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 , (4 <<8)|4, (4 <<8)|3, (4 <<8)|3, (4 <<8)|2, (4 <<8)|1, (4 <<8)|1},
/* 180km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 , (4 <<8)|4, (4 <<8)|3, (4 <<8)|3, (4 <<8)|2, (4 <<8)|1, (4 <<8)|1},
#endif
};

#if 1
const Uint16 OtdrPowerLevel1550[MEASURE_LENGTH_NUM][PULSE_WIDTH_NUM] = 
{
//            5ns  10ns  20ns  40ns  80ns   160ns  320ns   640ns     1280ns     2560ns     5120ns    10240ns    20480ns
#if TR600_A_CLASS
/*   1km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 ,     2 ,        2 ,        2 ,        1 ,        1,         1 },
/*   5km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 ,     2 ,        2 ,        2 ,        1 ,        1,         1 },
/*  10km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 ,     2 ,        2 ,        2 ,        1 ,        1,         1 },
/*  30km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 ,     2 ,        2 ,        2 ,        1 ,        1,         1 },
/*  60km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 ,     2 ,        2 ,        2 ,        1 ,        1,         1 },
/* 100km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 , (2 <<8)|2, (2 <<8)|2, (2 <<8)|2, (2 <<8)|1, (2 <<8)|1, (2 <<8)|1},
/* 180km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 , (2 <<8)|2, (2 <<8)|2, (2 <<8)|2, (2 <<8)|1, (2 <<8)|1, (2 <<8)|1},
#else   // TR600_C_CLASS
/*   1km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 ,     4 ,        4 ,        4 ,        4 ,        4,         4 },
/*   5km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 ,     4 ,        4 ,        4 ,        4 ,        4,         4 },
/*  10km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 ,     4 ,        4 ,        4 ,        4 ,        4 ,        4 },
/*  30km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 ,     4 ,        4 ,        4 ,        4 ,        4 ,        4 },
/*  60km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 ,     4 ,        4 ,        4 ,        4 ,        4 ,        4 },
/* 100km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 , (4 <<8)|4, (4 <<8)|3, (4 <<8)|3, (4 <<8)|2, (4 <<8)|2, (4 <<8)|2},
/* 180km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 , (4 <<8)|4, (4 <<8)|3, (4 <<8)|3, (4 <<8)|2, (4 <<8)|2, (4 <<8)|2},
#endif
};
#endif

const Uint16 OtdrPowerLevel1625[MEASURE_LENGTH_NUM][PULSE_WIDTH_NUM] = 
{
//            5ns  10ns  20ns  40ns  80ns   160ns  320ns   640ns     1280ns     2560ns     5120ns    10240ns    20480ns
#if TR600_A_CLASS
/*   1km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 ,     2 ,        2 ,        2 ,        1 ,        1,         1 },
/*   5km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 ,     2 ,        2 ,        2 ,        1 ,        1,         1 },
/*  10km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 ,     2 ,        2 ,        2 ,        1 ,        1,         1 },
/*  30km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 ,     2 ,        2 ,        2 ,        1 ,        1,         1 },
/*  60km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 ,     2 ,        2 ,        2 ,        1 ,        1,         1 },
/* 100km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 , (2 <<8)|2, (2 <<8)|2, (2 <<8)|2, (2 <<8)|1, (2 <<8)|1, (2 <<8)|1},
/* 180km */ { 2 ,  2 ,   2 ,   2 ,   2 ,     2 ,    2 , (2 <<8)|2, (2 <<8)|2, (2 <<8)|2, (2 <<8)|1, (2 <<8)|1, (2 <<8)|1},
#else   // TR600_C_CLASS
/*   1km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 ,     4 ,        4 ,        4 ,        4 ,        4,         4 },
/*   5km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 ,     4 ,        4 ,        4 ,        4 ,        4,         4 },
/*  10km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 ,     4 ,        4 ,        4 ,        4 ,        4 ,        4 },
/*  30km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 ,     4 ,        4 ,        4 ,        4 ,        4 ,        4 },
/*  60km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 ,     4 ,        4 ,        4 ,        4 ,        4 ,        4 },
/* 100km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 , (4 <<8)|4, (4 <<8)|3, (4 <<8)|3, (4 <<8)|2, (4 <<8)|2, (4 <<8)|2},
/* 180km */ { 4 ,  4 ,   4 ,   4 ,   4 ,     4 ,    4 , (4 <<8)|4, (4 <<8)|3, (4 <<8)|3, (4 <<8)|2, (4 <<8)|2, (4 <<8)|2},
#endif
};

/************************* 拼接时，不同量程脉宽波长使用的接收机控制表 ****************************/
// 2014-7-4 16:48:21 之后，对应硬件为V2.5
const Uint32 OtdrReceiver[MEASURE_LENGTH_NUM][PULSE_WIDTH_NUM] = 
{
//            5ns   10ns  20ns  40ns  80ns    160ns   320ns    640ns        1280ns        2560ns        5120ns       10240ns       20480ns
#if TR600_A_CLASS
/*   1km */ {  R_7, R_7,  R_7,  R_7,  R_A,    R_A,    R_A,     R_A,          R_A,          R_A,          R_A,          R_A,          R_A},
/*   5km */ {  R_7, R_7,  R_7,  R_7,  R_A,    R_A,    R_A,     R_A,          R_A,          R_A,          R_A,          R_A,          R_A},
/*  10km */ {  R_7, R_7,  R_7,  R_7,  R_A,    R_A,    R_A,     R_A,          R_A,          R_A,          R_A,          R_A,          R_A},
/*  30km */ {  R_7, R_7,  R_7,  R_7,  R_A,    R_A,    R_A,     R_A,          R_A,          R_A,          R_A,          R_A,          R_A},
/*  60km */ {  R_7, R_7,  R_7,  R_7,  R_A,    R_A,    R_A,     R_A,          R_A,          R_A,          R_A,          R_A,          R_A},
/* 100km */ {  R_7, R_7,  R_7,  R_7,  R_A,    R_A,    R_A, (R_C<<8)|R_A, (R_C<<8)|R_A, (R_C<<8)|R_A, (R_C<<8)|R_6, (R_C<<8)|R_6, (R_C<<8)|R_6},
/* 180km */ {  R_7, R_7,  R_7,  R_7,  R_A,    R_A,    R_A, (R_C<<8)|R_A, (R_C<<8)|R_A, (R_C<<8)|R_A, (R_C<<8)|R_6, (R_C<<8)|R_6, (R_C<<8)|R_6},
#else   // TR600_C_CLASS
/*   1km */ {  R_7, R_7,  R_7,  R_7,  R_A,    R_A,    R_A,     R_A,          R_A,          R_A,          R_A,          R_A,          R_A},
/*   5km */ {  R_7, R_7,  R_7,  R_7,  R_A,    R_A,    R_A,     R_A,          R_A,          R_A,          R_A,          R_A,          R_A},
/*  10km */ {  R_7, R_7,  R_7,  R_7,  R_A,    R_A,    R_A,     R_A,          R_A,          R_A,          R_A,          R_A,          R_A},
/*  30km */ {  R_7, R_7,  R_7,  R_7,  R_A,    R_A,    R_A,     R_A,          R_A,          R_A,          R_A,          R_A,          R_A},
/*  60km */ {  R_7, R_7,  R_7,  R_7,  R_A,    R_A,    R_A,     R_A,          R_A,          R_A,          R_A,          R_A,          R_A},
/* 100km */ {  R_7, R_7,  R_7,  R_7,  R_A,    R_A,    R_A, (R_C<<8)|R_6, (R_C<<8)|R_6, (R_C<<8)|R_6, (R_D<<8)|R_6, (R_D<<8)|R_6, (R_D<<8)|R_6},
/* 180km */ {  R_7, R_7,  R_7,  R_7,  R_A,    R_A,    R_A, (R_C<<8)|R_6, (R_C<<8)|R_6, (R_C<<8)|R_6, (R_D<<8)|R_6, (R_D<<8)|R_6, (R_D<<8)|R_6},
#endif
};


/*
 **************************************************************************************************
 *    End    of    File
 **************************************************************************************************
*/
